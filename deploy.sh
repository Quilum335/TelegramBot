#!/bin/bash

# –í—ã—Ö–æ–¥–∏–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ, –µ—Å–ª–∏ –∫–∞–∫–∞—è-–ª–∏–±–æ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º —Å—Ç–∞—Ç—É—Å–æ–º.
set -e

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Telegram-–±–æ—Ç–∞ –≤ /home..."

# --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã ---
# echo "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã..."
# sudo apt update && sudo apt upgrade -y

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–¥—Ä–∞ (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ) ---
# –≠—Ç–∞ —á–∞—Å—Ç—å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ª–æ–≥–∞.
# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–¥—Ä–∞, –Ω–æ –Ω–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç.
# if grep -q "Pending kernel upgrade!" <<< "$(/usr/lib/update-notifier/apt-check --human-readable)"; then
#     echo "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è–¥—Ä–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤–æ–µ —è–¥—Ä–æ."
#     echo "   –¢–µ–∫—É—â–µ–µ —è–¥—Ä–æ: $(uname -r)"
#     echo "   –û–∂–∏–¥–∞–µ–º–æ–µ —è–¥—Ä–æ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏: $(apt list --installed | grep linux-image | head -n 1 | awk '{print $1}') (–º–æ–∂–µ—Ç –±—ã—Ç—å –¥—Ä—É–≥–∏–º)"
# fi

# # --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ---
# echo "üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã..."
# # python-is-python3 –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ 'python' —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ python3
# sudo apt install -y python3 python3-pip python3-venv git python-is-python3 build-essential

# --- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±–æ—Ç–∞ ---
echo "üìÅ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±–æ—Ç–∞ (/home)..."
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±–æ—Ç–∞ –∫–∞–∫ /home
BOT_DIR="/home/SP"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /home
cd "$BOT_DIR" || { echo "–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é $BOT_DIR. –í—ã—Ö–æ–¥."; exit 1; }

echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –±–æ—Ç–∞ (main.py, requirements.txt, telegram-bot.service –∏ —Ç.–¥.) –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ $BOT_DIR."

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è ---
echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≤ $BOT_DIR/venv..."
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ venv, –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –µ–≥–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ -d "venv" ]; then
    echo "   –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ. –£–¥–∞–ª—è–µ–º –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º..."
    rm -rf venv
fi
python3 -m venv venv
source venv/bin/activate

# --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python ---
echo "üìö –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python –∏–∑ requirements.txt..."
# –û–±–Ω–æ–≤–ª—è–µ–º pip –≤–Ω—É—Ç—Ä–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
pip install --upgrade pip

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ requirements.txt, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—ã—Ç–∞—Ç—å—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
if [ -f "requirements.txt" ]; then
    pip install -r requirements.txt
else
    echo "–û–®–ò–ë–ö–ê: –§–∞–π–ª requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $BOT_DIR. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
    deactivate # –í—ã—Ö–æ–¥–∏–º –∏–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    exit 1
fi

# --- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π ---
echo "üìÇ –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (databases, sessions, logs) –≤ $BOT_DIR..."
mkdir -p databases sessions logs

# --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ ---
echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞..."
# –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ main.py —è–≤–ª—è–µ—Ç—Å—è –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –±–æ—Ç–∞
if [ -f "main.py" ]; then
    chmod +x main.py
else
    echo "–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: main.py –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –ø—Ä–∞–≤ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è main.py."
fi

# –ò–∑–º–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±–æ—Ç–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 'root'
BOT_USER="root"
if id "$BOT_USER" &>/dev/null; then
    echo "   –ò–∑–º–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ $BOT_DIR –Ω–∞ $BOT_USER:$BOT_USER..."
    chown -R "$BOT_USER":"$BOT_USER" "$BOT_DIR"
else
    echo "–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '$BOT_USER' –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞. –§–∞–π–ª—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å $(whoami)."
    echo "         –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ –≤—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ—Ç –∏–º–µ–Ω–∏ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
fi

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É–∂–±—ã Systemd ---
echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É–∂–±—É systemd –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞..."
SERVICE_FILE="telegram-bot.service"
if [ -f "$SERVICE_FILE" ]; then
    sudo cp "$SERVICE_FILE" /etc/systemd/system/
    sudo systemctl daemon-reload
    sudo systemctl enable "$SERVICE_FILE"
    echo "   –°–ª—É–∂–±–∞ systemd '$SERVICE_FILE' –≤–∫–ª—é—á–µ–Ω–∞. –û–Ω–∞ –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ."
else
    echo "–û–®–ò–ë–ö–ê: –§–∞–π–ª —Å–ª—É–∂–±—ã systemd '$SERVICE_FILE' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $BOT_DIR. –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –Ω–µ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω."
    echo "       –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ '$SERVICE_FILE' –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å systemd."
    exit 1
fi

# –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
deactivate

echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "--- –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ ---"
echo "–î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞—à–∏–º –±–æ—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:"
echo " ¬† –ó–∞–ø—É—Å–∫: sudo systemctl start telegram-bot"
echo " ¬† –û—Å—Ç–∞–Ω–æ–≤–∫–∞: sudo systemctl stop telegram-bot"
echo " ¬† –°—Ç–∞—Ç—É—Å: sudo systemctl status telegram-bot"
echo " ¬† –õ–æ–≥–∏: sudo journalctl -u telegram-bot -f"
echo ""
echo "–ï—Å–ª–∏ –≤—ã –≤–∏–¥–µ–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —è–¥—Ä–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞:"
echo "   sudo reboot"
echo ""
echo "–î–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ (–µ—Å–ª–∏ systemd –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∏–ª–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏):"
echo "   cd $BOT_DIR"
echo "   source venv/bin/activate"
echo "   python3 main.py"
echo "   deactivate"